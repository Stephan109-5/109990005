<!DOCTYPE html>
<html>
<head>
    <title>Falling Tetris Blocks</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body onload="initialGame()">
<script src="script.js"></script> 
<script>
var i = 0;
var pieceArray = [];
var piecePointer;
var startlist = ["S", "I", "E"];
var namelist = ["C", "S", "I", "E", "o", "t", "z", "l"];
var timecounter = 0;
var num = 0


function initialGame(){
    myGameArea.initial();
    drawBoard();
}

function startGame() {
    pieceArray = [];
    piecePointer = null;
    var startlist = ["S", "I", "E"];
    num = 0;
    clearInterval(myGameArea.interval);
    clearInterval(scoreInterval);
    myGameArea.start();
}

var myGameArea = {
    // container : document.createElement("div"),
    // gridDiv : document.createElement("div"),
    canvas : document.createElement("canvas"),
    // scoreCanvas: document.createElement("canvas"),
    initial : function(){
        this.canvas.width = 300;
        this.canvas.height = 540;
        this.context = this.canvas.getContext("2d");

        // this.scoreCanvas.width = 300;
        // this.scoreCanvas.height = 100;

        // this.container.setAttribute('id', 'container');
        // this.gridDiv.setAttribute('id', 'gridarea');
        // document.body.insertBefore(this.container, document.body.childNodes[0]);
        document.getElementById("grid_column").appendChild(this.canvas);
    },
    start : function() {
        this.interval = setInterval(updateGameArea, 50);
        window.addEventListener('mousedown', function (e) {
            myGameArea.x = e.pageX;
            myGameArea.y = e.pageY;
        })
        window.addEventListener('mouseup', function (e) {
            myGameArea.x = false;
            myGameArea.y = false;
        })
    },
    clear : function() {
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
    }
}

var context = myGameArea.canvas.getContext("2d");
function drawBoard(){
    context.strokeStyle = "white";
    context.lineWidth = 0.5; 
    for (var x = 0; x <= myGameArea.canvas.width; x += 30) {
        context.moveTo(x, 0);
        context.lineTo(x, myGameArea.canvas.height);
    }

    for (var x = 0; x <= myGameArea.canvas.height; x += 30) {
        context.moveTo(0, x);
        context.lineTo(myGameArea.canvas.width , x);
    }
    context.strokeStyle = "white";
    context.lineWidth = 0.5; 
    context.stroke();
}

function updateGameArea() {
    var name = "";
    var h = 0;

    myGameArea.clear();
    drawBoard();
    

    if (pieceArray.length == 0){
        pieceArray.push(new component("C", 135, -60));
        num++;
    }

    //when tetris block has passed 5 grid unit blocks, generates a new tetris block
    if ((pieceArray[pieceArray.length-1].y - (0.5*pieceArray[pieceArray.length-1].height)) >= 150){
        if (startlist.length > 0){
            // i++;
            name = startlist.shift();
            h = adjHeight(name);
            pieceArray.push(new component(name, 135, h));
            // pieceArray[i] = new component(name, 135, h);
        }
        else{
            name = randomLetter(namelist);
            h = adjHeight(name);
            pieceArray.push(new component(name, 135, h));
            // if (i < 5){
            //     i++;
            // }
            // else{
            //     i = 0;
            // }
            // name = randomLetter(namelist);
            // h = adjHeight(name);
            // pieceArray[i] = new component(name, 135, h);
            // // pieceArray.push(new component(randomLetter(namelist), 135, 0));
        }

        if (pieceArray.length > 4){
            pieceArray.shift();
        }
        num++;
        // if (i < 5){
        //     i += 1;
        // }
        // else{
        //     pieceArray.shift();
        // }
    }
    
    // if (i < 5){
    for (let j = 0; j < pieceArray.length; j++){
        try{
            if (((pieceArray[j].x - (0.5*pieceArray[j].width)) >= 0) && ((pieceArray[j].x + (0.5*pieceArray[j].width)) <= myGameArea.canvas.width))
                continue;
            else if ((pieceArray[j].x - (0.5*pieceArray[j].width)) <= 0)
                pieceArray[j].x = 0.5*pieceArray[j].width;
            else if ((pieceArray[j].x + (0.5*pieceArray[j].width)) >= myGameArea.canvas.width)
                pieceArray[j].x = myGameArea.canvas.width - 0.5*pieceArray[j].width;
        }
        finally{
            pieceArray[j].update();
        }

    }
        // }
        // else{
        //     for (let j = 3; j < pieceArray.length; j++){
        //         pieceArray[j].newPos();
        //         pieceArray[j].update();
        //     }
        // }
    if (timecounter == 20){
        for (let j = 0; j < pieceArray.length; j++){
            pieceArray[j].newPos();
        }
        timecounter = 0;
    }
    else
        timecounter++;

    for (let j = 0; j < pieceArray.length; j++){
        if (myGameArea.x && myGameArea.y) {
            if (pieceArray[j].clicked()){
                piecePointer = pieceArray[j];
            }
        }
    }

    try{
        piecePointer.selected();

        if (piecePointer.y - (0.5*piecePointer.height) > 540){
            // console.log(piecePointer.name);
            piecePointer = null;
        }
    }
    catch(err){

    }
    
}

function Left(piecePointer){
    // console.log((piecePointer.x - (0.5*piecePointer.width)));
    // if ((piecePointer.x - (0.5*piecePointer.width)) <= 0){
    //     piecePointer.x = 0.5*piecePointer.width;
    //     return;
    // }
    // else
    piecePointer.x -= 30;
    // return;
}

function Right(piecePointer){   
    // if ((piecePointer.x + (0.5*piecePointer.width)) >= myGameArea.canvas.width){
    //     piecePointer.x = 300 - 0.5*piecePointer.width;
    //     return;
    // }
    // else    
    piecePointer.x += 30;
    // return;
}

function Down(piecePointer){   
    piecePointer.y += 30;
}

function Rotate(piecePointer){
    piecePointer.rotate_flag = (piecePointer.rotate_flag + 1) % 4 ;

    // if ((piecePointer.x - (0.5*piecePointer.width)) <= 0){
    //     piecePointer.x = 0.5*piecePointer.width;
    //     return;
    // }
    // if ((piecePointer.x + (0.5*piecePointer.width)) >= myGameArea.canvas.width){
    //     piecePointer.x = 300 - 0.5*piecePointer.width;
    //     return;
    // }
}
</script>

    <div class="container">
        <div id="grid_column">
        </div>
        <div id="command_column">
            <canvas id="score" width="320" height="80""></canvas>
            <script>
                var s = document.getElementById("score");
                var s_ctx = s.getContext("2d");
                s_ctx.font = "25px Helvetica";
                const titletext1 = "Falling Tetris Blocks"
                const titletext2 = "Simulator 2022"

                const len1 = s_ctx.measureText(titletext1).width;
                const len2 = s_ctx.measureText(titletext2).width;
                var margin_to_add = (len1-len2)*0.5;

                s_ctx.fillText(titletext1, (0.5*(s.width-len1)), 35);
                s_ctx.fillText(titletext2, (0.5*(s.width-len2)), 65);
                
                let scoreInterval = null;
                // scoreInterval = setInterval(updateScore, 50);     
                function startInterval(scoreInterval){
                    scoreInterval = setInterval(updateScore, 50); 
                }
                
                function updateScore(){
                    var scoretext = "Score: " + num;
                    var len3 = s_ctx.measureText(scoretext).width;
                    s_ctx.clearRect(0, 0, s.width, s.height);
                    s_ctx.fillText(scoretext, (0.5*(s.width-len3)), 0.5*s.height+10);
                }
                
            </script>
            <div id="buttons">
                <button onclick="startGame(), startInterval(scoreInterval)" id="play"><img src="https://cdn-icons-png.flaticon.com/512/727/727245.png"></button>
                <button onclick="Left(piecePointer)" id="left"><img src="https://cdn-icons-png.flaticon.com/512/271/271226.png"></button>
                <button onclick="Right(piecePointer)" id="right"><img src="https://cdn-icons-png.flaticon.com/512/271/271226.png"></button>
                <button onclick="Down(piecePointer)" id="down"><img src="https://cdn-icons-png.flaticon.com/512/271/271226.png"></button>
                <button onclick="Rotate(piecePointer)" id="rotate"><img src="https://cdn-icons-png.flaticon.com/512/50/50453.png"></button>
            </div>
            <h3>Instructions</h3>
            <p>Click the Play button to start playing. The button can be clicked again to reset the game.
                <br>You may also click any of the tetris blocks falling. After being clicked, it will be highlighted by a red box around its shape.
                <br>The arrows and rotate buttons can be clicked to make the selected tetris block move in the desired direction or rotate.
            </p>
        </div>
    </div>
</body>
